name: Build & Release

on:
  push:
    tags:
      - 'v*.*.*'

permissions:
  contents: write   # required to create GitHub releases

jobs:
  # ── Windows EXE ─────────────────────────────────────────────────────────────
  build-windows:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v4
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Build EXE
        shell: pwsh
        run: |
          pyinstaller --onefile `
            --windowed `
            --name "AC_Career_GT_Edition" `
            --icon "static/logo.ico" `
            --add-data "templates;templates" `
            --add-data "static;static" `
            --add-data "config.json;." `
            --add-data "platform_paths.py;." `
            --collect-all flask `
            --collect-all flask_cors `
            --collect-all webview `
            app.py

      - uses: actions/upload-artifact@v4
        with:
          name: windows-exe
          path: dist/AC_Career_GT_Edition.exe

  # ── Linux AppImage ───────────────────────────────────────────────────────────
  build-linux:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v4
        with:
          python-version: '3.12'

      - name: Install GTK / WebKit dev libraries
        run: |
          sudo apt-get update -qq
          # Common deps
          sudo apt-get install -y \
            libcairo2-dev \
            pkg-config \
            python3-dev \
            libgirepository1.0-dev
          # webkit2gtk 4.1 on Ubuntu 24.04; fall back to 4.0 on older runners
          sudo apt-get install -y libwebkit2gtk-4.1-dev gir1.2-webkit2-4.1 || \
          sudo apt-get install -y libwebkit2gtk-4.0-dev gir1.2-webkit2-4.0

      - name: Install Python dependencies
        run: |
          pip install -r requirements.txt
          # Pin PyGObject to last version using gobject-introspection-1.0 (Ubuntu 24.04 compatible)
          pip install "PyGObject==3.48.2"

      - name: Download appimagetool
        run: |
          wget -q https://github.com/AppImage/AppImageKit/releases/download/continuous/appimagetool-x86_64.AppImage
          chmod +x appimagetool-x86_64.AppImage

      - name: Extract version from tag
        id: ver
        run: echo "VERSION=${GITHUB_REF_NAME#v}" >> $GITHUB_OUTPUT

      - name: Build AppImage
        env:
          VERSION: ${{ steps.ver.outputs.VERSION }}
          APPIMAGETOOL: ${{ github.workspace }}/appimagetool-x86_64.AppImage
          APPIMAGE_EXTRACT_AND_RUN: "1"   # run appimagetool without FUSE
        run: bash build.sh

      - uses: actions/upload-artifact@v4
        with:
          name: linux-appimage
          path: dist/AC_Career_GT_Edition-*-x86_64.AppImage

  # ── GitHub Release ───────────────────────────────────────────────────────────
  release:
    needs: [build-windows, build-linux]
    runs-on: ubuntu-latest
    steps:
      - name: Download Windows EXE
        uses: actions/download-artifact@v4
        with:
          name: windows-exe
          path: artifacts/

      - name: Download Linux AppImage
        uses: actions/download-artifact@v4
        with:
          name: linux-appimage
          path: artifacts/

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: artifacts/*
          generate_release_notes: true
