<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AC Career Manager</title>
    <link rel="icon" type="image/svg+xml" href="{{ url_for('static', filename='logo.svg') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <script>
      if (location.protocol === 'file:') {
        document.addEventListener('DOMContentLoaded', function() {
          document.body.innerHTML =
            '<div style="position:fixed;inset:0;display:flex;flex-direction:column;align-items:center;' +
            'justify-content:center;background:#07091A;color:#E8EAF0;font-family:system-ui;text-align:center;gap:1.5rem;padding:2rem">' +
            '<div style="font-size:3rem">&#9889;</div>' +
            '<h1 style="color:#E84A0A;font-size:1.4rem;letter-spacing:3px;text-transform:uppercase">Open via the app</h1>' +
            '<p style="color:#8890B0;max-width:440px;line-height:1.8">Double-click <strong>AC_Career_Manager.exe</strong> or <strong>start.bat</strong> to launch the app.</p>' +
            '</div>';
        });
      }
    </script>
</head>
<body>
<header class="topbar">
  <div class="topbar-inner">
    <div class="topbar-brand"><img src="{{ url_for('static', filename='logo.svg') }}" class="topbar-logo" alt="AC"><span class="topbar-title">AC CAREER</span></div>
    <div class="topbar-center" id="topbar-driver-name"></div>
    <div class="topbar-right">
        <span class="badge badge-tier" id="tier-badge">MX5 Cup</span>
        <span class="badge badge-season" id="season-badge">Season 1</span>
        <div class="topbar-sep"></div>
        <div class="tt-wrap" onclick="toggleTheme()" title="Toggle light/dark theme">
          <span class="tt-label" id="tt-label">Dark</span>
          <div class="tt-track"><div class="tt-thumb">ðŸŒ™</div></div>
        </div>
    </div>
  </div>
</header>
<div class="layout">
  <aside class="sidebar">
    <div class="card driver-card">
      <div class="driver-avatar" id="driver-avatar"><span id="driver-initials">?</span></div>
      <div class="driver-name" id="driver-name">No Driver</div>
      <div class="driver-team" id="driver-team">-</div>
      <div class="driver-car"  id="driver-car">-</div>
      <div class="driver-stats">
        <div class="dstat"><div class="dstat-val" id="driver-points">0</div><div class="dstat-lbl">Points</div></div>
        <div class="dstat"><div class="dstat-val" id="driver-pos">-</div><div class="dstat-lbl">Position</div></div>
        <div class="dstat"><div class="dstat-val" id="races-done">0/10</div><div class="dstat-lbl">Races</div></div>
      </div>
    </div>
    <div class="card actions-card">
      <button class="btn btn-race" onclick="startRace()">&#127937; Start Race</button>
      <div class="action-sep"></div>
      <button class="nav-btn" onclick="showView('standings')"><span class="nav-icon">&#127942;</span>Standings</button>
      <button class="nav-btn" onclick="openStats()"><span class="nav-icon">&#128200;</span>Stats</button>
      <button class="nav-btn" onclick="openConfig()"><span class="nav-icon">&#9881;</span>Settings</button>
      <div class="action-sep"></div>
      <button class="btn-ghost-sm" onclick="openNewCareer()">&#128260; New Career</button>
    </div>
  </aside>
  <main class="main">
    <div class="card calendar-card">
      <div class="calendar-header">
        <h2 class="section-title">Season Calendar</h2>
        <span class="calendar-progress" id="calendar-progress">0 / 10 races</span>
      </div>
      <div class="rounds-row" id="rounds-row"></div>
      <div class="next-race-bar" id="next-race-bar">
        <div class="nrb-left">
          <div class="nrb-label">NEXT RACE</div>
          <div class="nrb-track" id="nrb-track">-</div>
          <div class="nrb-meta"  id="nrb-meta">-</div>
        </div>
        <div class="nrb-right">
          <div class="nrb-ai-label">AI LEVEL</div>
          <div class="nrb-ai-val" id="nrb-ai">-</div>
        </div>
      </div>
      <div class="season-done-bar hidden" id="season-done-bar">
        &#127942; Season complete - check your contract offers below!
      </div>
    </div>
    <div id="view-standings" class="card view-card active">
      <!-- Tier tabs -->
      <div class="tier-tabs" id="tier-tabs">
        <button class="tier-tab" data-tier="0" onclick="switchStandingsTier(0)">MX5 Cup</button>
        <button class="tier-tab" data-tier="1" onclick="switchStandingsTier(1)">GT4</button>
        <button class="tier-tab" data-tier="2" onclick="switchStandingsTier(2)">GT3</button>
        <button class="tier-tab" data-tier="3" onclick="switchStandingsTier(3)">WEC</button>
      </div>
      <!-- Driver / Team toggle -->
      <div class="champ-tabs">
        <button class="champ-tab active" id="champ-tab-drivers" onclick="switchChampMode('drivers')">Drivers</button>
        <button class="champ-tab"        id="champ-tab-teams"   onclick="switchChampMode('teams')">Teams</button>
      </div>
      <div class="empty-state" id="standings-empty" style="display:none">Start a new career to see standings.</div>
      <div class="table-wrap">
        <table class="standings-table" id="standings-table">
          <thead><tr>
            <th class="col-pos">Pos</th>
            <th class="col-name" id="standings-col-label">Driver</th>
            <th class="col-pts">Pts</th>
            <th class="col-gap">Gap</th>
          </tr></thead>
          <tbody id="standings-body"></tbody>
        </table>
      </div>
    </div>
    <div id="view-stats" class="card view-card hidden">
      <h2 class="card-title">Statistics</h2>
      <div id="stats-content"></div>
    </div>
    <div id="view-result" class="card view-card hidden">
      <h2 class="section-title">Race Result</h2>
      <p class="view-subtitle" id="result-race-label">-</p>

      <!-- Auto-read section -->
      <div id="result-auto">
        <p class="result-auto-hint">Close Assetto Corsa and click the button to automatically import your result.</p>
        <button class="btn btn-race result-fetch-btn" onclick="fetchRaceResult()">&#128269; Import Result from AC</button>
        <div id="result-auto-status" class="result-auto-status"></div>
      </div>

      <!-- Auto-result display (shown when AC result is found) -->
      <div id="result-found" class="result-found hidden">
        <div class="result-found-grid">
          <div class="rf-item">
            <div class="rf-label">Position</div>
            <div class="rf-value rf-pos" id="rf-position">-</div>
          </div>
          <div class="rf-item">
            <div class="rf-label">Best Lap</div>
            <div class="rf-value" id="rf-best-lap">-</div>
          </div>
          <div class="rf-item">
            <div class="rf-label">Laps</div>
            <div class="rf-value" id="rf-laps">-</div>
          </div>
        </div>
        <!-- Post-Race Debrief Panel â€” shown when AC lap data is available -->
        <div id="debrief-panel" class="debrief-panel hidden">
          <div class="debrief-header">
            <span class="debrief-title">Engineer Report</span>
            <div class="consistency-wrap">
              <span class="consistency-label">Consistency</span>
              <span class="consistency-badge" id="debrief-consistency">â€“</span>
            </div>
          </div>
          <p class="debrief-report" id="debrief-report"></p>
          <div class="lap-sparkline" id="debrief-laps"></div>
        </div>
        <div class="form-actions" style="margin-top:1.25rem">
          <button class="btn btn-race" onclick="submitAutoResult()">&#9989; Save Result</button>
          <button class="btn btn-secondary" onclick="showManualForm('')">Enter Manually</button>
        </div>
      </div>

      <!-- Manual fallback form -->
      <div id="result-manual" class="result-manual hidden">
        <p class="result-manual-hint" id="result-manual-hint"></p>
        <form onsubmit="submitResult(event)" class="result-form">
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">Finish Position</label>
              <input type="number" id="finish-position" class="form-input input-pos" min="1" max="30" value="1" required>
            </div>
            <div class="form-group">
              <label class="form-label">Best Lap (mm:ss.sss)</label>
              <input type="text" id="best-lap" class="form-input" placeholder="02:15.345">
            </div>
          </div>
          <div class="form-actions">
            <button type="submit" class="btn btn-race">Save</button>
            <button type="button" class="btn btn-secondary" onclick="showView('standings')">Cancel</button>
          </div>
        </form>
      </div>
    </div>
    <div id="view-contracts" class="card view-card hidden">
      <h2 class="section-title">&#127942; Season Complete!</h2>
      <p class="view-subtitle" id="final-pos-text"></p>
      <h3 class="subsection-title">Contract Offers</h3>
      <div id="contracts-list" class="contracts-grid"></div>
    </div>
    <div id="view-config" class="card view-card hidden">
      <div class="view-header">
        <h2 class="section-title">&#9881; Settings</h2>
        <button class="close-btn" onclick="showView('standings')" title="Close">&#10005;</button>
      </div>

      <div class="settings-section">
        <div class="settings-section-title">Difficulty</div>
        <div class="setting-row">
          <div class="setting-label">
            <span>AI Base Level</span>
            <span class="setting-val" id="s-ai-level-val">85</span>
          </div>
          <input type="range" class="slider" id="s-ai-level" min="60" max="100" step="1" value="85"
                 oninput="document.getElementById('s-ai-level-val').textContent=this.value">
          <div class="slider-hints"><span>Easy (60)</span><span>Hard (100)</span></div>
        </div>
        <div class="setting-row">
          <div class="setting-label">
            <span>AI Variance per Race</span>
            <span class="setting-val" id="s-ai-var-val">&#177;1.5</span>
          </div>
          <input type="range" class="slider" id="s-ai-var" min="0" max="5" step="0.5" value="1.5"
                 oninput="document.getElementById('s-ai-var-val').textContent='&#177;'+this.value">
          <div class="slider-hints"><span>No variance</span><span>High variance</span></div>
        </div>
      </div>


      <div class="settings-section">
        <div class="settings-section-title">Race Conditions</div>
        <div class="setting-toggle-row">
          <div class="toggle-info">
            <span class="toggle-label">Dynamic Weather</span>
            <span class="toggle-desc">Variable weather per race (based on tier)</span>
          </div>
          <label class="toggle-switch">
            <input type="checkbox" id="s-dynamic-weather">
            <span class="toggle-slider"></span>
          </label>
        </div>
        <div class="setting-toggle-row">
          <div class="toggle-info">
            <span class="toggle-label">Night Cycle</span>
            <span class="toggle-desc">Day &#8594; dusk &#8594; night for endurance races (&#8805;30 laps)</span>
          </div>
          <label class="toggle-switch">
            <input type="checkbox" id="s-night-cycle">
            <span class="toggle-slider"></span>
          </label>
        </div>
      </div>

      <div class="settings-section">
        <div class="settings-section-title">Assetto Corsa</div>
        <div class="setting-row">
          <div class="setting-label"><span>Install Folder</span></div>
          <div class="path-row">
            <input type="text" id="s-ac-path" class="form-input path-input"
                   placeholder="C:\Program Files (x86)\Steam\steamapps\common\assettocorsa">
            <button class="btn btn-secondary btn-browse" onclick="browseAcFolder()" title="Browse">&#128193;</button>
          </div>
          <div class="slider-hints" id="s-ac-hint" style="color:var(--text-faint)"></div>
        </div>
      </div>

      <div class="form-actions" style="margin-top:1.5rem">
        <button class="btn btn-race"      onclick="saveSettings()">Save</button>
        <button class="btn btn-secondary" onclick="showView('standings')">Cancel</button>
      </div>
    </div>
  </main>
</div>
<div id="modal-race" class="modal-overlay hidden">
  <div class="modal-box">
    <div class="modal-header">
      <h2 class="modal-title">Race Details</h2>
      <button class="close-btn" onclick="closeModal('modal-race')">&#10005;</button>
    </div>
    <div id="race-details" class="race-detail-grid"></div>
    <div id="preflight-warnings" class="preflight-warnings hidden"></div>
    <div class="modal-actions">
      <button class="btn btn-race"      onclick="confirmStartRace('full_weekend')">&#127937; Full Weekend</button>
      <button class="btn btn-secondary" onclick="confirmStartRace('race_only')">&#9889; Race Only</button>
      <button class="btn btn-ghost"     onclick="closeModal('modal-race')">Cancel</button>
    </div>
  </div>
</div>
<div id="modal-new-career" class="modal-overlay hidden">
  <div class="modal-box wizard-box">
    <div class="modal-header">
      <h2 class="modal-title">New Career</h2>
      <button class="close-btn" onclick="closeModal('modal-new-career')">&#10005;</button>
    </div>
    <!-- Step indicator -->
    <div class="wizard-steps">
      <div class="wizard-dot active" id="wdot-1">1</div>
      <div class="wizard-line"></div>
      <div class="wizard-dot" id="wdot-2">2</div>
      <div class="wizard-line"></div>
      <div class="wizard-dot" id="wdot-3">3</div>
      <div class="wizard-line"></div>
      <div class="wizard-dot" id="wdot-4">4</div>
    </div>

    <!-- Page 1: Driver Name -->
    <div class="wizard-page" id="wizard-page-1">
      <div class="wizard-page-title">Driver Profile</div>
      <p class="modal-subtitle">Start fresh in MX5 Cup. All current progress will be lost.</p>
      <div class="form-group">
        <label class="form-label">Driver Name</label>
        <input type="text" id="new-driver-name" class="form-input" placeholder="Your name (used in AC)" maxlength="30">
        <div class="form-hint">This name appears in Assetto Corsa as your driver.</div>
      </div>
      <div class="modal-actions">
        <button class="btn btn-race"  onclick="wizardNext()">Next &#8594;</button>
        <button class="btn btn-ghost" onclick="closeModal('modal-new-career')">Cancel</button>
      </div>
    </div>

    <!-- Page 2: Difficulty -->
    <div class="wizard-page hidden" id="wizard-page-2">
      <div class="wizard-page-title">Difficulty</div>
      <p class="modal-subtitle">Set the AI challenge level for your career.</p>
      <div class="wizard-preset-grid" id="diff-grid">
        <div class="wizard-preset" data-val="rookie" onclick="selectPreset('diff','rookie',this)">
          <div class="preset-name">Rookie</div>
          <div class="preset-desc">AI &minus;10 &middot; Perfect for beginners</div>
        </div>
        <div class="wizard-preset" data-val="amateur" onclick="selectPreset('diff','amateur',this)">
          <div class="preset-name">Amateur</div>
          <div class="preset-desc">AI &minus;5 &middot; Learn the ropes</div>
        </div>
        <div class="wizard-preset active" data-val="pro" onclick="selectPreset('diff','pro',this)">
          <div class="preset-name">Pro</div>
          <div class="preset-desc">AI +0 &middot; Default challenge</div>
        </div>
        <div class="wizard-preset" data-val="legend" onclick="selectPreset('diff','legend',this)">
          <div class="preset-name">Legend</div>
          <div class="preset-desc">AI +5 &middot; Unforgiving pace</div>
        </div>
      </div>
      <div class="modal-actions">
        <button class="btn btn-race"  onclick="wizardNext()">Next &#8594;</button>
        <button class="btn btn-ghost" onclick="wizardPrev()">&#8592; Back</button>
      </div>
    </div>

    <!-- Page 3: Weather -->
    <div class="wizard-page hidden" id="wizard-page-3">
      <div class="wizard-page-title">Weather Mode</div>
      <p class="modal-subtitle">How much weather variety do you want in your career?</p>
      <div class="wizard-preset-grid" id="weather-grid">
        <div class="wizard-preset" data-val="always_clear" onclick="selectPreset('weather','always_clear',this)">
          <div class="preset-name">&#9728; Always Clear</div>
          <div class="preset-desc">Dry races every time</div>
        </div>
        <div class="wizard-preset active" data-val="realistic" onclick="selectPreset('weather','realistic',this)">
          <div class="preset-name">&#9925; Realistic Mix</div>
          <div class="preset-desc">Based on real track weather</div>
        </div>
        <div class="wizard-preset" data-val="wet_challenge" onclick="selectPreset('weather','wet_challenge',this)">
          <div class="preset-name">&#127783; Wet Challenge</div>
          <div class="preset-desc">Mostly wet &amp; overcast</div>
        </div>
      </div>
      <div class="modal-actions">
        <button class="btn btn-race"  onclick="wizardNext()">Next &#8594;</button>
        <button class="btn btn-ghost" onclick="wizardPrev()">&#8592; Back</button>
      </div>
    </div>

    <!-- Page 4: Track Library -->
    <div class="wizard-page hidden" id="wizard-page-4">
      <div class="wizard-page-title">Track Library</div>
      <p class="modal-subtitle">Scan your AC folder to pick which tracks appear in your career, or use the built-in defaults.</p>
      <div class="wizard-scan-row">
        <button class="btn btn-secondary" id="btn-scan-lib" onclick="scanLibrary()">&#128269; Scan My Library</button>
        <span class="form-hint" style="margin:0;align-self:center">or</span>
        <button class="btn btn-ghost" onclick="useDefaultTracks()">Use Defaults &amp; Start</button>
      </div>
      <div id="scan-loading" class="scan-loading hidden">
        <div class="scan-spinner"></div><span>Scanning AC content folder&hellip;</span>
      </div>
      <div id="scan-results" class="hidden">
        <div class="scan-filter-row">
          <button class="scan-filter-btn active" onclick="filterTracks('all',this)">All</button>
          <button class="scan-filter-btn" onclick="filterTracks('short',this)">&#8804;3 km (MX5)</button>
          <button class="scan-filter-btn" onclick="filterTracks('medium',this)">3&ndash;7 km</button>
          <button class="scan-filter-btn" onclick="filterTracks('long',this)">&gt;7 km</button>
        </div>
        <div id="track-checklist" class="track-checklist"></div>
        <div class="form-hint" id="scan-track-count"></div>
      </div>
      <div class="modal-actions" style="margin-top:1rem">
        <button class="btn btn-race"  id="btn-start-wizard" onclick="startCareerFromWizard()" style="display:none">&#127937; Start Career</button>
        <button class="btn btn-ghost" onclick="wizardPrev()">&#8592; Back</button>
      </div>
    </div>

  </div>
</div>
<!-- Driver profile modal -->
<div id="modal-driver" class="modal-overlay hidden">
  <div class="modal-box modal-driver-box">
    <div class="modal-header">
      <div>
        <span class="driver-nationality" id="dp-nationality"></span>
        <h2 class="modal-title" id="dp-name"></h2>
        <div class="modal-subtitle" id="dp-team"></div>
      </div>
      <button class="close-btn" onclick="closeModal('modal-driver')">&#10005;</button>
    </div>
    <div class="dp-style" id="dp-style"></div>
    <div class="dp-stats">
      <div class="dp-stat-row">
        <span class="dp-stat-label">SKILL</span>
        <div class="dp-bar-wrap"><div class="dp-bar dp-bar-skill" id="dp-skill-bar"></div></div>
        <span class="dp-stat-val" id="dp-skill-val"></span>
      </div>
      <div class="dp-stat-row">
        <span class="dp-stat-label">AGGRESSION</span>
        <div class="dp-bar-wrap"><div class="dp-bar dp-bar-aggr" id="dp-aggr-bar"></div></div>
        <span class="dp-stat-val" id="dp-aggr-val"></span>
      </div>
    </div>
    <div class="dp-section-label">THIS SEASON</div>
    <div class="dp-current" id="dp-current"></div>
    <div class="dp-section-label" id="dp-history-label" style="display:none">CAREER</div>
    <div class="dp-history" id="dp-history"></div>
  </div>
</div>
<!-- Setup overlay â€” shown when AC install path not set / invalid -->
<div id="setup-overlay" class="setup-overlay hidden">
  <div class="setup-box">
    <div class="setup-icon">&#9889;</div>
    <h1 class="setup-title">AC Career Manager</h1>
    <p class="setup-sub">Set your Assetto Corsa install folder to get started.</p>
    <div class="setting-label" style="text-align:left;margin-bottom:.5rem;margin-top:1rem">
      <span>Assetto Corsa folder</span>
    </div>
    <div class="path-row">
      <input type="text" id="setup-ac-path" class="form-input path-input"
             placeholder="C:\Program Files (x86)\Steam\steamapps\common\assettocorsa">
      <button class="btn btn-secondary btn-browse" onclick="browseSetupFolder()" title="Browse">&#128193;</button>
    </div>
    <div class="setup-hint" id="setup-hint"></div>
    <button class="btn btn-race setup-confirm" onclick="confirmSetup()">Continue &#8594;</button>
  </div>
</div>
<div id="toast" class="toast hidden"></div>
<script src="{{ url_for('static', filename='app.js') }}"></script>
</body>
</html>
